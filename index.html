<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>è³‡æ–™ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #f3f4f6;
        --surface: #ffffff;
        --primary: #195400;
        --primary-dark: #143f00;
        --danger: #dc2626;
        --border: #e5e7eb;
        --text-main: #111827;
        --text-sub: #6b7280;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: var(--bg);
        color: var(--text-main);
      }

      /* ãƒ¢ãƒã‚¤ãƒ«ã‚’åŸºæº–ã«ã—ãŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
      .app {
        width: 100%;
        background: var(--surface);
        min-height: 100vh;
      }

      .header {
        background: linear-gradient(135deg, #3a8d10, #195400);
        color: #f5fdf0;
        padding: 14px 16px 10px;
      }

      .header-title {
        font-size: 17px;
        font-weight: 600;
        letter-spacing: 0.02em;
      }

      .header-sub {
        margin-top: 4px;
        font-size: 12px;
        opacity: 0.9;
      }

      .main {
        padding: 16px 16px 20px;
      }

      .user-info {
        font-size: 12px;
        color: var(--text-sub);
        background: #f9fafb;
        border-radius: 10px;
        padding: 8px 10px;
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 14px;
        border: 1px dashed #e5e7eb;
      }

      .user-info-dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: var(--primary);
        box-shadow: 0 0 0 4px rgba(25, 84, 0, 0.35);
      }

      form {
        margin: 0;
      }

      .field {
        margin-bottom: 14px;
      }

      .field-label-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
      }

      label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        color: #374151;
      }

      .label-badge {
        font-size: 11px;
        color: var(--text-sub);
      }

      select,
      input[type="text"],
      textarea {
        width: 100%;
        padding: 9px 11px;
        border-radius: 10px;
        border: 1px solid var(--border);
        font-size: 14px;
        background: #f9fafb;
        transition:
          border-color 0.15s ease,
          box-shadow 0.15s ease,
          background 0.15s ease,
          transform 0.06s ease;
      }

      select:focus,
      input[type="text"]:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow:
          0 0 0 1px rgba(25, 84, 0, 0.45),
          0 4px 10px rgba(15, 23, 42, 0.12);
        background: #ffffff;
        transform: translateY(-1px);
      }

      textarea {
        resize: vertical;
        min-height: 70px;
        max-height: 200px;
      }

      .file-input-wrap {
        position: relative;
        border-radius: 10px;
        border: 1px dashed #d1d5db;
        padding: 10px 10px 8px;
        background: #f9fafb;
      }

      .file-input-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 6px;
      }

      .file-input-button {
        position: relative;
        overflow: hidden;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 7px 11px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.7);
        background: #ffffff;
        font-size: 12px;
        cursor: pointer;
        color: #111827;
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.12);
        transition:
          background 0.15s ease,
          transform 0.06s ease,
          box-shadow 0.15s ease;
      }

      .file-input-button:hover {
        background: #f3f4f6;
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(15, 23, 42, 0.14);
      }

      .file-input-button span.icon {
        font-size: 14px;
      }

      input[type="file"] {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
      }

      .file-input-help {
        font-size: 11px;
        color: var(--text-sub);
      }

      .file-input-meta {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-top: 4px;
        gap: 6px;
      }

      #sizeInfo {
        font-size: 11px;
        color: #4b5563;
      }

      #sizeInfo.warning {
        color: var(--danger);
        font-weight: 600;
      }

      .file-count-pill {
        font-size: 11px;
        color: var(--primary);
        background: #ecf4e3;
        border-radius: 999px;
        padding: 2px 8px;
        white-space: nowrap;
      }

      button#submitBtn {
        margin-top: 6px;
        background: var(--primary);
        color: #ffffff;
        width: 100%;
        border-radius: 999px;
        font-size: 14px;
        font-weight: 500;
        padding: 11px 16px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        border: none;
        box-shadow:
          0 8px 18px rgba(25, 84, 0, 0.32),
          0 0 0 1px rgba(25, 84, 0, 0.4);
        transition:
          transform 0.08s ease,
          box-shadow 0.12s ease,
          background 0.12s ease,
          opacity 0.12s ease;
      }

      button#submitBtn:hover:not(:disabled) {
        background: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow:
          0 12px 24px rgba(25, 84, 0, 0.38),
          0 0 0 1px rgba(25, 84, 0, 0.5);
      }

      button#submitBtn:active:not(:disabled) {
        transform: translateY(0);
        box-shadow:
          0 6px 14px rgba(25, 84, 0, 0.32),
          0 0 0 1px rgba(25, 84, 0, 0.5);
      }

      button#submitBtn:disabled {
        opacity: 0.7;
        cursor: default;
        box-shadow: none;
      }

      button#submitBtn .spinner {
        width: 14px;
        height: 14px;
        border-radius: 999px;
        border: 2px solid rgba(248, 250, 252, 0.55);
        border-top-color: #ffffff;
        animation: spin 0.7s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      #status {
        margin-top: 14px;
        font-size: 12px;
        color: var(--text-sub);
        min-height: 16px;
      }

      #status.ok {
        color: var(--primary);
      }

      #status.error {
        color: var(--danger);
      }

      /* PCè¡¨ç¤ºæ™‚ã®ã¿ã‚«ãƒ¼ãƒ‰åŒ–ãƒ»ç¸¦ä½™ç™½èª¿æ•´ */
      @media (min-width: 768px) {
        body {
          display: flex;
          justify-content: center;
          align-items: flex-start;
          padding: 24px 0;
        }

        .app {
          max-width: 480px;
          min-height: auto;
          border-radius: 18px;
          box-shadow:
            0 18px 40px rgba(15, 23, 42, 0.14),
            0 1px 3px rgba(15, 23, 42, 0.08);
          overflow: hidden;
        }

        .header {
          border-radius: 18px 18px 0 0;
        }

        .main {
          border-radius: 0 0 18px 18px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="header">
        <div class="header-title">è³‡æ–™ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
        <div class="header-sub">
          PDFå½¢å¼ã®è«‹æ±‚æ›¸ãƒ»é ˜åæ›¸ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„
        </div>
      </div>

      <div class="main">
        <div id="userInfo" class="user-info">
          <span class="user-info-dot"></span>
          <span>æ³•äººåã¾ãŸã¯æ°åã¨æ›¸é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</span>
        </div>

        <form id="uploadForm">
          <div class="field">
            <div class="field-label-row">
              <label for="entity">æ³•äººå / æ°å</label>
              <span class="label-badge">å¿…é ˆ</span>
            </div>
            <input
              id="entity"
              type="text"
              placeholder="ä¾‹ï¼‰SKIPç¨ç†å£«æ³•äºº / å±±ç”°å¤ªéƒ"
              required
            />
          </div>

          <div class="field">
            <div class="field-label-row">
              <label for="category">æ›¸é¡ã®ç¨®é¡</label>
              <span class="label-badge">å¿…é ˆ</span>
            </div>
            <select id="category" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="æ”¯æ‰•è«‹æ±‚æ›¸">æ”¯æ‰•è«‹æ±‚æ›¸</option>
              <option value="å£²ä¸Šè«‹æ±‚æ›¸">å£²ä¸Šè«‹æ±‚æ›¸</option>
              <option value="é ˜åæ›¸">é ˜åæ›¸</option>
              <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
          </div>

          <div class="field">
            <div class="field-label-row">
              <label for="memo">å‚™è€ƒ</label>
              <span class="label-badge">ä»»æ„</span>
            </div>
            <textarea id="memo" rows="3"></textarea>
          </div>

          <div class="field">
            <div class="field-label-row">
              <label for="files">PDFãƒ•ã‚¡ã‚¤ãƒ«</label>
              <span class="label-badge">è¤‡æ•°é¸æŠå¯</span>
            </div>

            <div class="file-input-wrap">
              <div class="file-input-top">
                <label class="file-input-button">
                  <span class="icon">ğŸ“</span>
                  <span>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</span>
                  <input
                    id="files"
                    name="files"
                    type="file"
                    accept="application/pdf"
                    multiple
                    required
                  />
                </label>
                <div class="file-count-pill" id="fileCountPill">
                  ãƒ•ã‚¡ã‚¤ãƒ«æœªé¸æŠ
                </div>
              </div>
              <div class="file-input-help">
                1å›ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§åˆè¨ˆ40MBã¾ã§ã€‚å¿…è¦ãªPDFã‚’ã¾ã¨ã‚ã¦é¸æŠã§ãã¾ã™ã€‚
              </div>
              <div class="file-input-meta">
                <div id="sizeInfo"></div>
              </div>
            </div>
          </div>

          <button id="submitBtn" type="submit">
            <span id="submitBtnLabel">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹</span>
          </button>
        </form>

        <div id="status"></div>
      </div>
    </div>

    <script>
      const GAS_ENDPOINT =
        "https://script.google.com/macros/s/AKfycbw3KHviRJrUAfrsr_ad60QmGHi9l32G_48ziqZXAWDZhUehmA9FoQlrw1nqS2aH8fk/exec";

      const MAX_TOTAL_BYTES = 40 * 1024 * 1024; // 40MB

      function formatMb(bytes) {
        return (bytes / (1024 * 1024)).toFixed(1);
      }

      function updateSizeInfo() {
        const fileInput = document.getElementById("files");
        const sizeInfo = document.getElementById("sizeInfo");
        const fileCountPill = document.getElementById("fileCountPill");

        const files = fileInput.files ? Array.from(fileInput.files) : [];

        if (!files.length) {
          sizeInfo.textContent = "";
          sizeInfo.classList.remove("warning");
          fileCountPill.textContent = "ãƒ•ã‚¡ã‚¤ãƒ«æœªé¸æŠ";
          return;
        }

        const totalBytes = files.reduce((sum, f) => sum + f.size, 0);
        const totalMb = formatMb(totalBytes);
        const maxMb = formatMb(MAX_TOTAL_BYTES);

        sizeInfo.textContent =
          "ç¾åœ¨ã®åˆè¨ˆã‚µã‚¤ã‚º: " + totalMb + " MB / " + maxMb + " MB";
        fileCountPill.textContent = files.length + "ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠä¸­";

        if (totalBytes > MAX_TOTAL_BYTES) {
          sizeInfo.classList.add("warning");
        } else {
          sizeInfo.classList.remove("warning");
        }
      }

      function setStatus(msg, type) {
        const el = document.getElementById("status");
        el.textContent = msg || "";
        el.classList.remove("ok");
        el.classList.remove("error");
        if (type === "ok") el.classList.add("ok");
        if (type === "error") el.classList.add("error");
      }

      function setSubmitting(isSubmitting) {
        const btn = document.getElementById("submitBtn");
        const label = document.getElementById("submitBtnLabel");

        if (isSubmitting) {
          btn.disabled = true;
          label.innerHTML =
            '<span class="spinner"></span><span>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</span>';
        } else {
          btn.disabled = false;
          label.textContent = "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹";
        }
      }

      async function submitForm(event) {
        event.preventDefault();

        const entity = document.getElementById("entity").value.trim();
        const category = document.getElementById("category").value;
        const memo = document.getElementById("memo").value;
        const fileInput = document.getElementById("files");
        const files = fileInput.files ? Array.from(fileInput.files) : [];

        if (!entity) {
          alert("æ³•äººåã¾ãŸã¯æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        if (!files.length) {
          alert("PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        if (!category) {
          alert("æ›¸é¡ã®ç¨®é¡ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
          return;
        }

        const totalBytes = files.reduce((sum, f) => sum + f.size, 0);
        if (totalBytes > MAX_TOTAL_BYTES) {
          const mb = formatMb(totalBytes);
          const maxMb = formatMb(MAX_TOTAL_BYTES);
          alert(
            "ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆè¨ˆã‚µã‚¤ã‚ºãŒ " +
              mb +
              " MB ã‚ã‚Šã¾ã™ã€‚\n" +
              "1å›ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯åˆè¨ˆ " +
              maxMb +
              " MB ã¾ã§ã§ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†ã‘ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚"
          );
          return;
        }

        if (!GAS_ENDPOINT) {
          alert("GAS_ENDPOINT ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
          return;
        }

        setStatus("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™â€¦");
        setSubmitting(true);

        const formData = new FormData();
        formData.append("entity", entity);
        formData.append("category", category);
        formData.append("memo", memo);
        files.forEach((file) => {
          formData.append("files", file, file.name);
        });

        try {
          const res = await fetch(GAS_ENDPOINT, {
            method: "POST",
            body: formData,
          });

          let data = null;
          try {
            data = await res.json();
          } catch (e) {
            // JSONä»¥å¤–ãŒè¿”ã£ã¦ããŸå ´åˆ
          }

          if (!res.ok || !data || data.success === false) {
            const msg =
              (data && data.message) ||
              "ã‚µãƒ¼ãƒå´ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚(status " + res.status + ")";
            setStatus(msg, "error");
            setSubmitting(false);
            return;
          }

          setStatus(data.message || "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸã€‚", "ok");
          setSubmitting(false);
          document.getElementById("uploadForm").reset();
          updateSizeInfo();
        } catch (err) {
          console.error(err);
          setStatus("ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", "error");
          setSubmitting(false);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        updateSizeInfo();
        document
          .getElementById("uploadForm")
          .addEventListener("submit", submitForm);
        document
          .getElementById("files")
          .addEventListener("change", updateSizeInfo);
      });
    </script>
  </body>
</html>